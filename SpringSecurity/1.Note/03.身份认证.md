# 03.身份认证

## 1. WebSecurityConfigurerAdapter

- 开启 SpringSecurity 过滤链
  - `@EnableWebSecurity`
  - `@Configuration`

## 2. Http 认证

### 2.1 Basic认证

- ![image-20210723161721254](https://raw.githubusercontent.com/TWDH/Leetcode-From-Zero/pictures/img/image-20210723161721254.png)

```java
@Configuration
@EnableWebSecurity
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {
    /**
     * 认证管理器：
     *  1. 认证信息（用户名、密码）
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        super.configure(auth);
    }

    /**
     * 资源权限配置
     *  1. 被拦截的资源
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.httpBasic() // 采用 httpBasic 认证方式
                .and()
                .authorizeRequests() // 认证请求
                .anyRequest().authenticated() //所有访问该应用的 http 请求，都需要身份认证才可以访问
        ;
    }
}
```

### 2.2 表单认证

- `http.formLogin()`

```java
@Configuration
@EnableWebSecurity
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {

    // 指定加密方式
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    /**
     * 认证管理器：
     *  1. 认证信息（用户名、密码）
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        // 设置用户名、密码（必须加密）、权限
        auth.inMemoryAuthentication()
                .withUser("hezhu") // 用户名
                .password(passwordEncoder().encode("123456")) // 密码
                .authorities("ADMIN"); // 权限
    }

    /**
     * 资源权限配置
     *  1. 被拦截的资源
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // 采用 formLogin 认证方式
        http.formLogin()
                .and()
                .authorizeRequests() // 认证请求
                .anyRequest().authenticated(); //所有访问该应用的 http 请求，都需要身份认证才可以访问

    }
}
```



## 3. 认证管理器

![image-20210723163827133](https://raw.githubusercontent.com/TWDH/Leetcode-From-Zero/pictures/img/image-20210723163827133.png)

- 设置用户名、密码，储存到内存中（inMemoryAuthentication）
- 密码：必须加密，不能使用明文
  - `PasswordEncoder`

```java
@Configuration
@EnableWebSecurity
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {

    // 指定加密方式
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    /**
     * 认证管理器：
     *  1. 认证信息（用户名、密码）
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        // 设置用户名、密码（必须加密）、权限
        auth.inMemoryAuthentication()
                .withUser("hezhu") // 用户名
                .password(passwordEncoder().encode("123456")) // 密码
                .authorities("ADMIN"); // 权限
    }
}
```

## 4. 认证流程

1. FilterSecurityInterceptor
2. UsernamePasswordAuthenticationFilter
   - attemptAuthentication
3. BasicAuthenticationFilter（与 form 登录对应）
   - BasicAuthenticationConverter.convert()：
     - 获取 HttpServletRequest 请求头：`"Authorization"`
     - 请求头：`basic hezhu:123456`，使用 `":"` 截取

![image-20210723165115098](https://raw.githubusercontent.com/TWDH/Leetcode-From-Zero/pictures/img/image-20210723165115098.png)





















































